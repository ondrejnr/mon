name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'services/**'
      - 'online-retail/**'
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.filter.outputs.changes }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          frontend: 'services/frontend/**'
          order-service: 'services/order-service/**'
          order-worker: 'services/order-worker/**'
          payment-service: 'services/payment-service/**'
          product-service: 'services/product-service/**'
          user-service: 'services/user-service/**'
          products-subgraph: 'services/products-subgraph/**'

  build:
    needs: detect-changes
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: ${{ fromJSON(needs.detect-changes.outputs.services) }}
    steps:
    - uses: actions/checkout@v4
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    - name: Build and push
      uses: docker/build-push-action@v5
      with:
        context: services/${{ matrix.service }}
        push: true
        tags: |
          ondrejnr1/${{ matrix.service }}:latest
          ondrejnr1/${{ matrix.service }}:${{ github.sha }}
    - name: Update kustomization
      run: |
        cd online-retail
        if [ -f kustomization.yaml ]; then
          kustomize edit set image ondrejnr1/${{ matrix.service }}:${{ github.sha }}
        else
          echo "Kustomization not found, skipping update"
        fi
    - name: Commit changes
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"
        git add online-retail/kustomization.yaml
        git commit -m "chore: update ${{ matrix.service }} image to ${{ github.sha }}" || echo "No changes"
        git push

  smoke-tests:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Run smoke tests
      run: |
        chmod +x online-retail/tests/smoke-test.sh
        ./online-retail/tests/smoke-test.sh
    - name: Notify on failure
      if: failure()
      run: |
        curl -X POST -H "Content-type: application/json" --data '{"text":"ðŸš¨ Smoke testy zlyhali po nasadenÃ­!"}' ${{ secrets.SLACK_WEBHOOK }} || true
