---
- name: Create lamp namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: lamp

- name: Create Apache index ConfigMap
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: apache-index
        namespace: lamp
      data:
        index.php: "<h1>Ahoj z k3s klastra (DockerHub: {{ docker_hub_user }})</h1><?php phpinfo(); ?>"

- name: Create PostgreSQL secret
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: postgresql-secret
        namespace: lamp
      type: Opaque
      stringData:
        POSTGRES_PASSWORD: "{{ postgres_password }}"

- name: Create LAMP Services (for Prometheus)
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "{{ item.name }}"
        namespace: lamp
      spec:
        selector:
          app: "{{ item.app }}"
        ports: "{{ item.ports }}"
  loop:
    - name: apache-php
      app: apache-php
      ports:
        - { name: http, port: 80 }
        - { name: apache-metrics, port: 9117 }
        - { name: php-metrics, port: 9253 }
    - name: postgresql
      app: postgresql
      ports:
        - { name: postgres, port: 5432 }
        - { name: postgres-metrics, port: 9187 }

- name: Deploy PostgreSQL
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: postgresql
        namespace: lamp
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: postgresql
        template:
          metadata:
            labels:
              app: postgresql
          spec:
            containers:
              - name: postgresql
                image: "postgres:{{ postgresql_version }}"
                envFrom:
                  - secretRef:
                      name: postgresql-secret
              - name: postgres-exporter
                image: prometheuscommunity/postgres-exporter
                ports:
                  - containerPort: 9187

- name: Deploy Apache+PHP
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: apache-php
        namespace: lamp
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: apache-php
        template:
          metadata:
            labels:
              app: apache-php
          spec:
            containers:
              - name: apache
                # Používame tvoj Docker Hub user, defaultne padback na php:8.2-apache ak obraz neexistuje
                image: "{{ docker_hub_user }}/apache-php:latest"
                imagePullPolicy: IfNotPresent
                ports:
                  - containerPort: 80
                volumeMounts:
                  - name: web-content
                    mountPath: /var/www/html/index.php
                    subPath: index.php
              - name: php-fpm
                image: "php:8.2-fpm"
              - name: apache-exporter
                image: lusotycoon/apache-exporter
              - name: phpfpm-exporter
                image: hipages/php-fpm_exporter
            volumes:
              - name: web-content
                configMap:
                  name: apache-index
